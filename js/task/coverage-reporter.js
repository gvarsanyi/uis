// Generated by CoffeeScript 1.7.1
(function() {
  var CoverageReporter, Task, config, fs, glob, karma,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  fs = require('fs');

  glob = require('glob');

  karma = require('karma');

  Task = require('../task');

  config = require('../config');

  CoverageReporter = (function(_super) {
    __extends(CoverageReporter, _super);

    function CoverageReporter() {
      this.wrapError = __bind(this.wrapError, this);
      this.work = __bind(this.work, this);
      this.size = __bind(this.size, this);
      this.condition = __bind(this.condition, this);
      return CoverageReporter.__super__.constructor.apply(this, arguments);
    }

    CoverageReporter.prototype.name = 'coverageReporter';

    CoverageReporter.prototype.condition = function() {
      var _ref;
      return config.test.coverage && !!config[this.source.name].files && this.source.tasks.filesLoader.count() && !((_ref = this.source.tasks.tester.warning()) != null ? _ref.length : void 0);
    };

    CoverageReporter.prototype.size = function() {
      return this._result || {};
    };

    CoverageReporter.prototype.work = function() {
      var args;
      return this.preWork((args = arguments), (function(_this) {
        return function(callback) {
          var err, finish, finished, item, list, options, repo, test_file, tester, _i, _j, _k, _len, _len1, _len2, _ref, _ref1;
          finished = false;
          finish = function() {
            if (finished) {
              return;
            }
            finished = true;
            return glob(_this.source.tmp + '.coverage/text/**/coverage.txt', function(err, files) {
              if (err) {
                _this.error(err);
                return callback();
              } else if (!files.length) {
                _this.error('coverage output file generation failed');
                return callback();
              } else if (files.length > 1) {
                console.log(files);
                _this.error('coverage output file generation ambiguity');
                return callback();
              } else {
                return fs.readFile(files[0], {
                  encoding: 'utf8'
                }, function(err, data) {
                  var branches, dir, file, functions, info, item, line, lines, lowest, msg, parts, report, statements, _i, _j, _len, _len1, _ref, _ref1, _ref2, _ref3;
                  if (err) {
                    _this.error(err);
                    return callback();
                  } else {
                    report = {
                      files: {},
                      dirs: {}
                    };
                    lowest = [];
                    dir = null;
                    _ref = data.split('\n');
                    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                      line = _ref[_i];
                      if (!(line.substr(0, 4) !== 'File' && line[0] !== '-')) {
                        continue;
                      }
                      parts = line.split(' | ');
                      _ref1 = (function() {
                        var _j, _len1, _ref1, _results;
                        _ref1 = parts.slice(1, 5);
                        _results = [];
                        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                          item = _ref1[_j];
                          _results.push(Number(item.replace('|', '').trim()));
                        }
                        return _results;
                      })(), statements = _ref1[0], branches = _ref1[1], functions = _ref1[2], lines = _ref1[3];
                      info = {
                        statements: statements,
                        branches: branches,
                        functions: functions,
                        lines: lines
                      };
                      if (line.substr(0, 6) === '      ') {
                        file = dir + parts[0].trim();
                        report.files[file] = info;
                        if (statements < 80) {
                          lowest.push({
                            file: file,
                            statements: statements
                          });
                        }
                      } else if (line.substr(0, 3) === '   ') {
                        dir = parts[0].trim();
                        report.dirs[dir] = info;
                      } else if (line.substr(0, 9) === 'All files') {
                        report.all = info;
                      }
                    }
                    if (((_ref2 = report.all) != null ? _ref2.statements : void 0) && report.all.statements < 80) {
                      lowest.sort(function(a, b) {
                        if (a.statements > b.statements) {
                          return 1;
                        }
                        return -1;
                      });
                      msg = 'Files not meeting the 80% bar:';
                      if (lowest.length > 10) {
                        lowest = lowest.slice(0, 10);
                        msg = 'Files not meeting the 80% bar - 10 lowest coverages:';
                      }
                      for (_j = 0, _len1 = lowest.length; _j < _len1; _j++) {
                        item = lowest[_j];
                        msg += '\n  ' + item.file + ' (' + item.statements + '%)';
                      }
                      _this[report.all.statements < 60 ? 'error' : 'warning']({
                        title: 'Low test coverage',
                        description: report.all.statements + '% of all statements covered.\n\n' + msg
                      });
                    }
                    _ref3 = report.files;
                    for (file in _ref3) {
                      info = _ref3[file];
                      if (info.statements < 80) {
                        _this[info.statements < 60 ? 'error' : 'warning']({
                          file: file,
                          title: 'Low test coverage',
                          description: info.statements + '% of statements covered.'
                        });
                      }
                    }
                    _this.result(report);
                    return callback();
                  }
                });
              }
            });
          };
          try {
            if (!(config.test.files && typeof config.test.files === 'object')) {
              config.test.files = [config.test.files];
            }
            tester = _this.source.tasks.tester;
            options = tester.getDefaultOptions('dot', tester.getCloneDeployment(), config.test.files);
            _ref = config.test.files;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              test_file = _ref[_i];
              if (test_file.indexOf('.coffee') > -1) {
                options.preprocessors[test_file] = 'coffee';
              }
            }
            if (config.test.coverage) {
              options.reporters.push('coverage');
              _ref1 = config.test.repos;
              for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                item = _ref1[_j];
                if (!(!(item.thirdParty || item.testOnly))) {
                  continue;
                }
                list = item.repo;
                if (typeof list !== 'object') {
                  list = [list];
                }
                for (_k = 0, _len2 = list.length; _k < _len2; _k++) {
                  repo = list[_k];
                  options.preprocessors[_this.source.repoTmp + 'clone' + _this.source.projectPath + '/' + repo] = 'coverage';
                }
              }
              options.coverageReporter = {
                reporters: [
                  {
                    type: 'html',
                    dir: _this.source.tmp + '.coverage/html/'
                  }, {
                    type: 'lcovonly',
                    dir: _this.source.tmp + '.coverage/lcov/'
                  }, {
                    type: 'text',
                    dir: _this.source.tmp + '.coverage/text/',
                    file: 'coverage.txt'
                  }
                ]
              };
              if (config.test.teamcity) {
                options.coverageReporter.reporters.push({
                  type: 'teamcity'
                });
              }
            }
            return karma.server.start(options, function(exit_code) {
              return finish();
            });
          } catch (_error) {
            err = _error;
            _this.error(err);
            return finish();
          }
        };
      })(this));
    };

    CoverageReporter.prototype.wrapError = function(inf) {
      if (!(inf && typeof inf === 'object' && (inf.title != null) && (inf.description != null))) {
        return CoverageReporter.__super__.wrapError.apply(this, arguments);
      }
      return inf;
    };

    return CoverageReporter;

  })(Task);

  module.exports = CoverageReporter;

}).call(this);
